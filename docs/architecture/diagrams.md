# Git Quest - アーキテクチャ図

このドキュメントでは、Git Questのシステムアーキテクチャを図解します。

## 1. システム全体構成

```
┌─────────────────────────────────────────────────────────┐
│                    ブラウザ環境                          │
│                                                         │
│  ┌───────────────────────────────────────────────────┐ │
│  │                React Application                  │ │
│  │                                                   │ │
│  │  ┌─────────────────────────────────────────────┐ │ │
│  │  │          UIコンポーネント層               │ │ │
│  │  │                                             │ │ │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐ │ │ │
│  │  │  │ Header   │  │ Sidebar  │  │Terminal  │ │ │ │
│  │  │  └──────────┘  └──────────┘  └──────────┘ │ │ │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐ │ │ │
│  │  │  │ Editor   │  │SourceCtl │  │Instruct  │ │ │ │
│  │  │  └──────────┘  └──────────┘  └──────────┘ │ │ │
│  │  └─────────────────┬───────────────────────── ┘ │ │
│  │                    │                             │ │
│  │  ┌─────────────────▼───────────────────────────┐ │ │
│  │  │         状態管理層（Zustand）                │ │ │
│  │  │                                             │ │ │
│  │  │  ┌───────────────────────────────────────┐ │ │ │
│  │  │  │       useAppStore                    │ │ │ │
│  │  │  │  - gitState                          │ │ │ │
│  │  │  │  - currentStep                       │ │ │ │
│  │  │  │  - terminalOutput                    │ │ │ │
│  │  │  │  - executeCommand()                  │ │ │ │
│  │  │  │  - stageFile()                       │ │ │ │
│  │  │  └───────────────────────────────────────┘ │ │ │
│  │  └─────────────────┬───────────────────────────┘ │ │
│  │                    │                             │ │
│  │  ┌─────────────────▼───────────────────────────┐ │ │
│  │  │           サービス層                         │ │ │
│  │  │                                             │ │ │
│  │  │  ┌──────────────────────────────────────┐  │ │ │
│  │  │  │     TutorialService (統合管理)       │  │ │ │
│  │  │  └──────────────┬───────────────────────┘  │ │ │
│  │  │                 │                           │ │ │
│  │  │  ┌──────────────▼───────┬──────────────┐   │ │ │
│  │  │  │    GitService        │GitValidator  │   │ │ │
│  │  │  └──────────────────────┴──────────────┘   │ │ │
│  │  │  ┌──────────────┬──────────────────────┐   │ │ │
│  │  │  │CommandParser │ StepValidator        │   │ │ │
│  │  │  └──────────────┴──────────────────────┘   │ │ │
│  │  │  ┌──────────────┬──────────────────────┐   │ │ │
│  │  │  │FileSystemSvc │ RemoteSimulator      │   │ │ │
│  │  │  └──────────────┴──────────────────────┘   │ │ │
│  │  └─────────────────┬───────────────────────────┘ │ │
│  │                    │                             │ │
│  │  ┌─────────────────▼───────────────────────────┐ │ │
│  │  │        外部ライブラリ層                      │ │ │
│  │  │                                             │ │ │
│  │  │  ┌─────────────────────────────────────┐   │ │ │
│  │  │  │     isomorphic-git                  │   │ │ │
│  │  │  │     (Git操作の実装)                 │   │ │ │
│  │  │  └─────────────────────────────────────┘   │ │ │
│  │  │  ┌─────────────────────────────────────┐   │ │ │
│  │  │  │     LightningFS                     │   │ │ │
│  │  │  │     (仮想ファイルシステム)           │   │ │ │
│  │  │  └─────────────────────────────────────┘   │ │ │
│  │  └─────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
│  ┌───────────────────────────────────────────────────┐ │
│  │              IndexedDB (ブラウザストレージ)        │ │
│  │                                                   │ │
│  │  /remote-repo/  (架空のリモートリポジトリ)         │ │
│  │  /workspace/    (ユーザーのワークスペース)         │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## 2. サービス間の依存関係

```
┌──────────────────────────────────────────────────┐
│              TutorialService                     │
│          (オーケストレーター)                     │
└─────────┬────────────────────────────────────────┘
          │
          ├─────────┐
          │         │
    ┌─────▼───┐  ┌─▼──────────┐
    │GitService│  │GitValidator│
    └─────┬────┘  └─┬──────────┘
          │         │
          │    ┌────▼──────────┐
          │    │CommandParser  │
          │    └───────────────┘
          │
          │    ┌────────────────┐
          │    │StepValidator   │
          │    └────┬───────────┘
          │         │
    ┌─────▼─────────▼───────────┐
    │   FileSystemService        │
    │   (シングルトン)            │
    └────────────┬───────────────┘
                 │
    ┌────────────▼───────────────┐
    │   LightningFS (IndexedDB)  │
    └────────────────────────────┘

    ┌───────────────────────────┐
    │   RemoteSimulator          │
    │   (リモートリポジトリ模擬)  │
    └─┬─────────────────────┬───┘
      │                     │
  ┌───▼──────┐      ┌───────▼────────┐
  │GitService│      │FileSystemService│
  └──────────┘      └────────────────┘
```

## 3. コマンド実行フロー

```
ユーザーが「git add test.txt」と入力
          │
          ▼
┌──────────────────────────────────┐
│  Terminal コンポーネント          │
│  - onCommand('git add test.txt') │
└────────────┬─────────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│  useAppStore                     │
│  - executeCommand()              │
└────────────┬─────────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│  TutorialService                 │
│  - executeCommand()              │
└────┬───────────────────┬─────────┘
     │                   │
     ▼                   │
┌─────────────────┐      │
│ GitValidator    │      │
│ - validate()    │      │
│   ✓ 許可コマンド? │      │
│   ✓ 形式正しい?  │      │
└────┬────────────┘      │
     │ OK               │
     ▼                  │
┌─────────────────┐     │
│ CommandParser   │     │
│ - parse()       │     │
│   {command:'add'│     │
│    args:['test']│     │
└────┬────────────┘     │
     │                  │
     ▼                  │
┌─────────────────┐     │
│ GitService      │     │
│ - add()         │◄────┘
│   実行           │
└────┬────────────┘
     │
     ▼
┌─────────────────┐
│ isomorphic-git  │
│ - git.add()     │
└────┬────────────┘
     │
     ▼
┌─────────────────┐
│ LightningFS     │
│ ファイル更新     │
└────┬────────────┘
     │
     ▼
┌──────────────────────────────┐
│ StepValidator                │
│ - validateStep()             │
│   ✓ファイルがステージ済み?   │
└────┬─────────────────────────┘
     │ OK
     ▼
┌──────────────────────────────┐
│ TutorialService              │
│ - advanceStep()              │
│   次のステップへ              │
└────┬─────────────────────────┘
     │
     ▼
┌──────────────────────────────┐
│ useAppStore                  │
│ - refreshGitState()          │
│   状態更新                    │
└────┬─────────────────────────┘
     │
     ▼
┌──────────────────────────────┐
│ UIコンポーネント              │
│ 再レンダリング                │
└──────────────────────────────┘
```

## 4. GUI操作のフロー

```
ユーザーが「+」ボタンをクリック（ステージング）
          │
          ▼
┌──────────────────────────────────┐
│  SourceControlView               │
│  - onClick={() =>                │
│      onStageFile('test.txt')}    │
└────────────┬─────────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│  useAppStore                     │
│  - stageFile('test.txt')         │
└────────────┬─────────────────────┘
             │
             │ 内部的にコマンドに変換
             ▼
┌──────────────────────────────────┐
│  TutorialService                 │
│  - executeCommand(               │
│      'git add test.txt'          │
│    )                             │
└────────────┬─────────────────────┘
             │
             ▼
      （以降は通常のコマンド実行フローと同じ）

【重要ポイント】
GUIの操作も内部的にはGitコマンドとして実行される
→ ターミナルとGUIで同じバリデーション・実行パイプラインを通る
→ コードの重複を避け、一貫性を保つ
```

## 5. ステップ進行の状態遷移

```
┌────────────┐
│  Step 0    │  初期状態（説明）
│  (initial) │  [次へボタン]
└──────┬─────┘
       │
       ▼
┌────────────┐
│  Step 1    │  git clone
│  (clone)   │  → /workspace/にリポジトリ作成
└──────┬─────┘
       │
       ▼
┌────────────┐
│  Step 2    │  git checkout -b feature/xxx
│ (branch)   │  → 新ブランチ作成・切替
└──────┬─────┘
       │
       ▼
┌────────────┐
│  Step 3    │  greeting.txt編集
│  (edit)    │  → "Hello, Git!"追加
└──────┬─────┘
       │
       ▼
┌────────────┐
│  Step 4    │  git add greeting.txt
│   (add)    │  → ステージング
└──────┬─────┘
       │
       ▼
┌────────────┐
│  Step 5    │  git commit -m "..."
│  (commit)  │  → コミット作成
└──────┬─────┘
       │
       ▼
┌────────────┐
│  Step 6    │  git push origin feature/xxx
│  (push)    │  → リモートにプッシュ
└──────┬─────┘
       │
       │ ターミナルステージ完了
       │
       ▼
┌────────────┐
│  Step 20   │  GUIでmainに戻る
│ (gui:switch)│ → ステータスバーからブランチ選択
└──────┬─────┘
       │
       ▼
┌────────────┐
│  Step 21   │  GUIでブランチ作成
│ (gui:branch│  → 「+ 新しいブランチの作成...」
└──────┬─────┘
       │
       ▼
┌────────────┐
│  Step 31   │  GUIでファイル編集
│ (gui:edit) │  → エディタで編集
└──────┬─────┘
       │
       ▼
┌────────────┐
│  Step 41   │  GUIでステージング
│ (gui:add)  │  → +ボタンクリック
└──────┬─────┘
       │
       ▼
┌────────────┐
│  Step 51   │  GUIでコミット
│(gui:commit)│  → コミットボタンクリック
└──────┬─────┘
       │
       ▼
┌────────────┐
│  Step 61   │  GUIでプッシュ
│ (gui:push) │  → プッシュボタンクリック
└──────┬─────┘
       │
       ▼
┌────────────┐
│  完了       │  🎉 チュートリアル終了
└────────────┘

【重要ポイント】
- Step 6 → Step 21 への遷移でステージ切替
- ID が 0,1,2...6 → 21,31,41...61 と飛ぶのは意図的
  （将来の中間ステップ追加を考慮）
```

## 6. 仮想ファイルシステムの構造

```
IndexedDB (LightningFS)
│
├─ /remote-repo/              ← 架空のリモートリポジトリ
│  ├─ .git/
│  │  ├─ HEAD
│  │  ├─ config
│  │  ├─ objects/
│  │  └─ refs/
│  ├─ README.md
│  ├─ greeting.txt
│  └─ src/
│     └─ main.js
│
└─ /workspace/                ← ユーザーのワークスペース
   ├─ .git/                   (clone後に作成される)
   │  ├─ HEAD
   │  ├─ config
   │  ├─ objects/
   │  └─ refs/
   ├─ README.md               (clone後にコピーされる)
   ├─ greeting.txt            (ユーザーが編集)
   └─ src/
      └─ main.js

【データフロー】
1. RemoteSimulator が /remote-repo/ を作成
2. ユーザーが git clone を実行
3. /remote-repo/ から /workspace/ にファイルコピー
4. ユーザーは /workspace/ で作業
5. git push で /remote-repo/ に反映（シミュレート）
```

## 7. リセット処理のフロー

```
ユーザーが「リセット」ボタンをクリック
          │
          ▼
┌──────────────────────────────────┐
│  Header コンポーネント            │
│  - onReset()                     │
└────────────┬─────────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│  useAppStore                     │
│  - reset()                       │
└────────────┬─────────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│  resetFileSystem()               │
│  - LightningFSを wipe: true で   │
│    再作成                         │
│  - IndexedDB完全クリア            │
└────────────┬─────────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│  useAppStore.initialize()        │
│  - 全サービスを再初期化           │
│  - TutorialService.initialize()  │
└────────────┬─────────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│  RemoteSimulator                 │
│    .createRemoteRepository()     │
│  - /remote-repo/ を再作成        │
└────────────┬─────────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│  状態をクリア                     │
│  - currentStep = 0               │
│  - terminalOutput = []           │
│  - gitState = 初期値             │
└────────────┬─────────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│  UIコンポーネント                 │
│  初期状態で再レンダリング          │
└──────────────────────────────────┘
```

## 8. エラーハンドリングフロー

```
ユーザーが不正なコマンドを入力
          │
          ▼
┌──────────────────────────────────┐
│  GitValidator                    │
│  - validateCommand()             │
└────────────┬─────────────────────┘
             │
             ├─ 許可されていないコマンド
             │  → passed: false
             │     error: "not allowed at this step"
             │     hint: "Allowed commands: ..."
             │
             ├─ 引数不足
             │  → passed: false
             │     error: "requires a file path"
             │     hint: "Usage: git add <file>"
             │
             └─ 形式エラー
                → passed: false
                   error: "Invalid command"
                   hint: "Check your command syntax"
                   │
                   ▼
┌──────────────────────────────────┐
│  TutorialService                 │
│  - CommandExecutionResult        │
│    { success: false,             │
│      error: "...",               │
│      hint: "..." }               │
└────────────┬─────────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│  useAppStore                     │
│  - terminalOutputに追加          │
│    "Error: ..."                  │
│    "Hint: ..."                   │
└────────────┬─────────────────────┘
             │
             ▼
┌──────────────────────────────────┐
│  Terminal コンポーネント          │
│  エラーメッセージを赤色で表示      │
└──────────────────────────────────┘
```

---

これらの図は、システムの理解を助けるためのものです。実際のコードを読む際の参考にしてください。
